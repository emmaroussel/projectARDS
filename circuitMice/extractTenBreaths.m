function [extractedBreaths,indivBreaths] = extractTenBreaths(miceLabelStr)
% Function which extracts 10 breaths towards the end of each PEEP ladder
% step. Measurements extracted are pressure (P), volume (V), flow (Q), time
% (experimental time) and time0 (individual breath time starting at t=0).
%
% INPUT:
%   miceLabelStr = string containing the .mat mouse file
% OUTPUTS:
%   extractedBreaths = structure with 5 fields (P,V,Q,t,t0) with dimension 
%   equal to # ladder steps and which contains the measurements during the
%   whole ten breaths
%   individualBreaths = structure with 5 fields (P,V,Q,t,t0) and dimension
%   equal to # ladder steps x # extracted breaths, where each extracted
%   breaths are individually delineated
%
% Sep 2022

% Load data for given mice
load(miceLabelStr);

% Use these settings for the VT6 breaths
theRR = 3; 
theIE = 1;
whichPEEPs =  [1 3 5 6 7 8 7 6 5 3 1]; 
whichRR =     [1 1 1 1 1 1 1 1 1 1 1]*theRR;
whichIE =     [1 1 1 1 1 1 1 1 1 1 1]*theIE;
whichAscDsc=  [1 1 1 1 1 1 2 2 2 2 2];

% Define 1st breath to extract as a proportion of all breaths of a block
facFirstBreath = 0.9; 
nBreathsToExtract = 10;
extractedBreaths = struct();
indivBreaths = struct();

for currentBlock = 1:length(whichPEEPs) 

    nBreathsInBlock = allData(1).howManyOfEachBreath(...
        whichPEEPs(currentBlock), whichRR(currentBlock),...
        whichIE(currentBlock), whichAscDsc(currentBlock));

    indBeg = floor(nBreathsInBlock*facFirstBreath);
    indEnd = indBeg+nBreathsToExtract-1;
    b = 1;

    allVtr = []; allPtr = []; allQ = []; allTime = []; allTime0 = []; 
  
    for whichBreath = indBeg:indEnd
        
        Vtr = allData(whichPEEPs(currentBlock), whichRR(currentBlock),...
            whichIE(currentBlock), whichAscDsc(currentBlock), ...
            whichBreath).Vtr;
        
        Ptr = allData(whichPEEPs(currentBlock), whichRR(currentBlock),...
            whichIE(currentBlock), whichAscDsc(currentBlock), ...
            whichBreath).Ptr;

        Q = allData(whichPEEPs(currentBlock), whichRR(currentBlock),...
            whichIE(currentBlock), whichAscDsc(currentBlock), ...
            whichBreath).Q;
    
        time = allData(whichPEEPs(currentBlock), whichRR(currentBlock),... 
            whichIE(currentBlock), whichAscDsc(currentBlock), ...
            whichBreath).time;

        time0 = allData(whichPEEPs(currentBlock), whichRR(currentBlock),... 
            whichIE(currentBlock), whichAscDsc(currentBlock), ...
            whichBreath).time0;

        % Some mice .mat files have a different format for Vtr and Q
        % (Vtr and Q are line vectors instead of column ones)
        % e.g., CTL-016, CTL-033, LAV-008
        if size(Vtr,2) > 1
           allVtr = [allVtr;Vtr'];
           allPtr = [allPtr;Ptr];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
           allQ = [allQ;Q'];
           allTime = [allTime;time'];
           allTime0 = [allTime0;time0'];
    
           indivBreaths(currentBlock,b).V = Vtr';
           indivBreaths(currentBlock,b).P = Ptr;
           indivBreaths(currentBlock,b).Q = Q';
           indivBreaths(currentBlock,b).t = time';
           indivBreaths(currentBlock,b).t0 = time0';
        else 
           allVtr = [allVtr;Vtr];
           allPtr = [allPtr;Ptr];
           allQ = [allQ;Q];
           allTime = [allTime;time'];
           allTime0 = [allTime0;time0'];
    
           indivBreaths(currentBlock,b).V = Vtr;
           indivBreaths(currentBlock,b).P = Ptr;
           indivBreaths(currentBlock,b).Q = Q;
           indivBreaths(currentBlock,b).t = time';
           indivBreaths(currentBlock,b).t0 = time0';
        end

       b = b + 1;

    end

    extractedBreaths(currentBlock).V = allVtr;
    extractedBreaths(currentBlock).P = allPtr;
    extractedBreaths(currentBlock).Q = allQ;
    extractedBreaths(currentBlock).t = allTime;
    extractedBreaths(currentBlock).t0 = allTime0;
end

end